{% extends "base.html" %}
{% load custom_tags %}
{% load tz %}

{% block title %}Modo Intensivo{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-bold text-red-600 dark:text-red-400">🔥 Modo Intensivo</h1>
  <a href="{% url 'home' %}" class="bg-green-500 text-white px-4 py-2 rounded">🏠 Inicio</a>
</div>

<p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
  Estás en el <strong>modo intensivo de ultra repetición</strong>, ideal para preparar pruebas con alto volumen de contenido.
  Las preguntas se repetirán cada 10 min, 30 min, 1 h o 6 h dependiendo de tu nivel de seguridad.
</p>

<form method="GET" action="" class="mb-6">
  <label for="tema" class="block mb-1 text-gray-900 dark:text-white">Selecciona un tema:</label>
  <select id="tema" name="tema" class="w-full p-2 rounded bg-white dark:bg-gray-700 dark:text-white border border-gray-300 mb-2">
    <option value="">-- Todos los temas --</option>
    {% for padre in temas %}
      {% if not padre.padre %}
        <option value="{{ padre.nombre }}" {% if tema_seleccionado == padre.nombre %}selected{% endif %}>
          {{ padre.nombre }}
        </option>
        {% for subtema in temas %}
          {% if subtema.padre and subtema.padre.id == padre.id %}
            <option value="{{ subtema.nombre }}" {% if tema_seleccionado == subtema.nombre %}selected{% endif %}>
              &nbsp;&nbsp;&nbsp;↳ {{ subtema.nombre }}
            </option>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
  </select>
  <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Filtrar</button>
</form>

{% if repeticion %}
<div class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white p-6 rounded-xl shadow max-w-2xl mx-auto">

  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="pregunta_id" value="{{ repeticion.pregunta.id }}">
    <input type="hidden" name="tema" value="{{ tema_seleccionado }}">

    <p class="text-gray-900 dark:text-white font-semibold text-lg mb-4">{{ repeticion.pregunta.pregunta }}</p>

    <div class="space-y-3">
      {% for letra, texto in alternativas %}
        <label class="block text-gray-800 dark:text-white">
          <input type="radio" name="respuesta" value="{{ letra }}" {% if respuesta_usuario == letra %}checked{% endif %} {% if mostrar_explicacion %}disabled{% endif %}>
          {{ letra }}. {{ texto }}
        </label>
      {% endfor %}
    </div>

    {% if not mostrar_explicacion %}
      <button type="submit" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Enviar Respuesta</button>
    {% endif %}
  </form>

  {% if mensaje %}
    <p class="mt-4 font-bold text-lg 
      {% if "Correcto" in mensaje %}text-green-500 dark:text-green-300
      {% else %}text-red-500 dark:text-red-300{% endif %}">
      {{ mensaje }}
    </p>
  {% endif %}

  {% if mostrar_explicacion %}
    <div class="mt-4 p-4 bg-green-100 dark:bg-green-900 text-gray-800 dark:text-white rounded">
      <strong>Explicación:</strong><br>
      {{ repeticion.pregunta.explicacion }}
    </div>

    <form method="POST" class="mt-4">
      {% csrf_token %}
      <input type="hidden" name="pregunta_id" value="{{ repeticion.pregunta.id }}">
      <input type="hidden" name="tema" value="{{ tema_seleccionado }}">
      <p class="mb-2 text-gray-900 dark:text-white"><strong>¿Qué tan difícil fue?</strong></p>

      <div class="grid gap-3 sm:grid-cols-2 md:grid-cols-4">
        {% for nivel, texto, clase in niveles_textos %}
        <div class="boton-dificultad">
          <button name="nivel" value="{{ nivel }}" class="{{ clase }} text-white px-3 py-2 rounded w-full">{{ texto }}</button>
          <div class="respuesta-fsrs-preview text-sm mt-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white p-2 rounded">
            🕒 Se repetirá en {{ repeticion_preview|dict_key:nivel|dict_key:"intervalo" }}<br>
            📅 ({{ repeticion_preview|dict_key:nivel|dict_key:"fecha"|localtime|date:"H:i" }})
          </div>
        </div>
        {% endfor %}
      </div>
    </form>
  {% endif %}

  <!-- Estadísticas -->
  <hr class="my-8 border-t border-gray-300 dark:border-gray-600">
  <div class="mt-10 flex justify-center">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">

      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow w-52">
        <p class="text-sm text-gray-500 dark:text-gray-300">🧠 Nuevas hoy</p>
        <h2 class="text-2xl font-bold">{{ tarjetas_nuevas }}</h2>
      </div>

      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow w-52">
        <p class="text-sm text-gray-500 dark:text-gray-300">🔁 Para repasar</p>
        <h2 class="text-2xl font-bold">{{ tarjetas_para_repasar }}</h2>
      </div>

      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow w-52">
        <p class="text-sm text-gray-500 dark:text-gray-300">✅ Estudiadas hoy</p>
        <h2 class="text-2xl font-bold">{{ total_estudiadas }}</h2>
      </div>

    </div>
  </div>
</div>
{% else %}
  <p class="italic text-gray-600 dark:text-gray-300">No hay preguntas disponibles para este tema aún.</p>
{% endif %}
{% endblock %}
