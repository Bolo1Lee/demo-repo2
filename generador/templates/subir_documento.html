{% extends "base.html" %}

{% block title %}Subir Documento{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
  <!-- T√≠tulo y bot√≥n de regreso -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">üìÑ Subir Documento para Generar Preguntas</h1>
    <a href="{% url 'home' %}" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2 w-fit">
      üè† Volver al Inicio
    </a>
  </div>

  <form method="POST" enctype="multipart/form-data" class="space-y-6" onsubmit="mostrarLoader()">
    {% csrf_token %}

    <!-- Archivo -->
    <div>
      <label for="archivo" class="block font-semibold mb-1">Selecciona un archivo (.pdf, .ppt, .pptx o .txt):</label>
      <input type="file" name="archivo" id="archivo" accept=".pdf,.ppt,.pptx,.txt"
        class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700" required />
    </div>

    <!-- Seleccionar tema existente -->
    <div>
      <label for="tema_existente" class="block font-semibold mb-1">Seleccionar tema:</label>
      <select name="tema_existente" id="tema_existente"
        class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
        <option value="">-- Escoge un tema existente --</option>
        {% for t in temas %}
          {% if t.padre %}
            <option value="{{ t.id }}">{{ t.padre.nombre }} > {{ t.nombre }}</option>
          {% else %}
            <option value="{{ t.id }}">{{ t.nombre }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <!-- Crear nuevo tema y subtema -->
    <div class="border p-4 rounded bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
      <h2 class="font-bold text-gray-800 dark:text-gray-100 mb-2">‚ûï Crear nuevo tema y/o subtema</h2>

      <!-- Nuevo tema principal -->
      <div class="mb-4">
        <label for="tema_padre_nuevo" class="block font-semibold mb-1">Nuevo tema principal:</label>
        <input type="text" name="tema_padre_nuevo" id="tema_padre_nuevo" placeholder="Ej: Medicina de Urgencias"
          class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700" />
      </div>

      <!-- Subtema -->
      <div class="mb-4">
        <label for="tema_nuevo" class="block font-semibold mb-1">Nuevo subtema:</label>
        <input type="text" name="tema_nuevo" id="tema_nuevo" placeholder="Ej: Estratificaci√≥n de riesgo"
          class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700" />
      </div>

      <!-- O seleccionar tema padre existente -->
      <div>
        <label for="tema_padre" class="block font-semibold mb-1">
          Tema padre (opcional):
          <span class="text-sm text-gray-500 dark:text-gray-400">(Si seleccionas uno, se crear√° como subtema)</span>
        </label>
        <select name="tema_padre" id="tema_padre"
          class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
          <option value="">-- Sin padre / tema principal --</option>
          {% for t in temas %}
            <option value="{{ t.id }}">{{ t.nombre }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Tipo de pregunta -->
    <div>
      <label for="tipo" class="block font-semibold mb-1">Tipo de pregunta:</label>
      <select name="tipo" id="tipo"
        class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
        <option value="clinica">Cl√≠nica</option>
        <option value="conceptual">Conceptual</option>
      </select>
    </div>

    <!-- Cantidad -->
    <div>
      <label for="cantidad" class="block font-semibold mb-1">Cantidad de preguntas:</label>
      <select name="cantidad" id="cantidad"
        class="w-full p-2 border rounded bg-white dark:bg-gray-800 dark:border-gray-700">
        <option value="5">5</option>
        <option value="10">10</option>
      </select>
    </div>

    <!-- Bot√≥n -->
    <div class="flex items-center gap-4">
      <button type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded shadow">
        Generar Preguntas
      </button>
      <div id="loader" class="hidden animate-spin rounded-full h-8 w-8 border-t-4 border-blue-500 border-solid"></div>
    </div>
  </form>

  {% if error %}
    <div class="mt-6 text-red-600 font-semibold">{{ error }}</div>
  {% endif %}

  {% if preguntas %}
    <div class="mt-10">
      <h2 class="text-xl font-bold mb-4">üìã Preguntas generadas</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border rounded bg-white dark:bg-gray-800">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="px-4 py-2 text-left">Pregunta</th>
              <th class="px-4 py-2 text-left">Alternativas</th>
              <th class="px-4 py-2 text-left">Correcta</th>
              <th class="px-4 py-2 text-left">Explicaci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for p in preguntas %}
              <tr class="border-t dark:border-gray-700">
                <td class="px-4 py-2">{{ p.pregunta }}</td>
                <td class="px-4 py-2">
                  <ul class="list-disc ml-4">
                    <li><strong>A:</strong> {{ p.alternativa_a }}</li>
                    <li><strong>B:</strong> {{ p.alternativa_b }}</li>
                    <li><strong>C:</strong> {{ p.alternativa_c }}</li>
                    <li><strong>D:</strong> {{ p.alternativa_d }}</li>
                  </ul>
                </td>
                <td class="px-4 py-2 font-bold">{{ p.respuesta_correcta }}</td>
                <td class="px-4 py-2">{{ p.explicacion }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if preguntas_descartadas %}
    <div class="mt-10 bg-yellow-100 dark:bg-yellow-900 border border-yellow-400 dark:border-yellow-700 p-4 rounded">
      <h2 class="text-lg font-bold text-yellow-900 dark:text-yellow-100 mb-2">‚ùó Preguntas descartadas: {{ preguntas_descartadas|length }}</h2>
      <ul class="list-disc pl-6 text-sm text-yellow-800 dark:text-yellow-100 space-y-3">
        {% for item in preguntas_descartadas %}
          <li>
            <strong>Raz√≥n:</strong> {{ item.razon }}<br>
            <code class="block whitespace-pre-wrap text-xs bg-yellow-50 dark:bg-yellow-800 p-2 rounded mt-1">{{ item.contenido }}</code>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</div>

<script>
  function mostrarLoader() {
    document.getElementById("loader").classList.remove("hidden");
  }
</script>
{% endblock %}
